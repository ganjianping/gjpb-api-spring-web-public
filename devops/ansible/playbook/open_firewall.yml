---
- name: Configure firewall for GJPB API outbound HTTPS
  hosts: ubuntu_server
  become: yes

  tasks:
    - name: Ensure UFW is installed
      apt:
        name: ufw
        state: present
        update_cache: yes

    - name: Set default incoming policy to deny
      community.general.ufw:
        direction: incoming
        policy: deny

    - name: Set default outgoing policy to allow
      community.general.ufw:
        direction: outgoing
        policy: allow

    - name: Allow outbound HTTPS traffic (port 443)
      community.general.ufw:
        rule: allow
        direction: out
        port: '443'
        proto: tcp
        comment: 'Allow outbound HTTPS for downloading images and external APIs'

    - name: Allow outbound HTTP traffic (port 80)
      community.general.ufw:
        rule: allow
        direction: out
        port: '80'
        proto: tcp
        comment: 'Allow outbound HTTP for redirects and http resources'

    - name: Allow outbound DNS over UDP (port 53)
      community.general.ufw:
        rule: allow
        direction: out
        port: '53'
        proto: udp
        comment: 'Allow DNS queries for hostname resolution (UDP)'

    - name: Allow outbound DNS over TCP (port 53)
      community.general.ufw:
        rule: allow
        direction: out
        port: '53'
        proto: tcp
        comment: 'Allow DNS zone transfers / fallbacks (TCP)'

    - name: Allow inbound MySQL (port 3306)
      community.general.ufw:
        rule: allow
        direction: in
        port: '3306'
        proto: tcp
        comment: 'Allow inbound MySQL connections to remote DB servers'

    - name: Allow incoming SSH (port 22)
      community.general.ufw:
        rule: allow
        direction: in
        port: '22'
        proto: tcp
        comment: 'Allow incoming SSH connections'

    - name: Allow incoming HTTP (port 80)
      community.general.ufw:
        rule: allow
        direction: in
        port: '80'
        proto: tcp
        comment: 'Allow incoming HTTP traffic'

    - name: Allow incoming HTTPS (port 443)
      community.general.ufw:
        rule: allow
        direction: in
        port: '443'
        proto: tcp
        comment: 'Allow incoming HTTPS traffic'

    - name: Ensure UFW is enabled
      community.general.ufw:
        state: enabled

    - name: Reload UFW to apply latest rules
      community.general.ufw:
        state: reloaded

    - name: Display firewall status
      command: ufw status verbose
      register: ufw_status
      changed_when: false

    - name: Show current firewall rules
      debug:
        var: ufw_status.stdout_lines
