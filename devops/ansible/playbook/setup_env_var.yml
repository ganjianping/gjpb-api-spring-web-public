- name: Setup system global environment variables
  hosts: ubuntu_server
  become: yes
  gather_facts: yes

  tasks:
    - name: Ensure required variables are defined
      assert:
        that:
          - DB_URL is defined
          - DB_USERNAME is defined
          - DB_PASSWORD is defined
          - JWT_SECRET_KEY is defined
        fail_msg: "Required variables (DB_URL, DB_USERNAME, DB_PASSWORD, JWT_SECRET_KEY) must be defined in group_vars"

    - name: Set database and JWT environment variables in /etc/environment
      lineinfile:
        dest: /etc/environment
        regexp: "^{{ item.key }}="
        line: "{{ item.key }}={{ item.value }}"
        create: yes
        mode: '0644'
      loop:
        - { key: 'DB_URL', value: "{{ DB_URL }}" }
        - { key: 'DB_USERNAME', value: "{{ DB_USERNAME }}" }
        - { key: 'DB_PASSWORD', value: "{{ DB_PASSWORD }}" }
        - { key: 'JWT_SECRET_KEY', value: "{{ JWT_SECRET_KEY }}" }
      no_log: true  # Don't log sensitive values

    - name: Create environment variables file for profile.d
      copy:
        dest: /etc/profile.d/app_env.sh
        mode: '0644'
        content: |
          # Application environment variables
          export DB_URL="{{ DB_URL }}"
          export DB_USERNAME="{{ DB_USERNAME }}"
          export DB_PASSWORD="{{ DB_PASSWORD }}"
          export JWT_SECRET_KEY="{{ JWT_SECRET_KEY }}"
      no_log: true  # Don't log sensitive values

    - name: Verify environment variables are set
      shell: |
        source /etc/profile.d/app_env.sh
        echo "DB_URL is set: $([ -n "$DB_URL" ] && echo 'yes' || echo 'no')"
        echo "DB_USERNAME is set: $([ -n "$DB_USERNAME" ] && echo 'yes' || echo 'no')"
        echo "DB_PASSWORD is set: $([ -n "$DB_PASSWORD" ] && echo 'yes' || echo 'no')"
        echo "JWT_SECRET_KEY is set: $([ -n "$JWT_SECRET_KEY" ] && echo 'yes' || echo 'no')"
      args:
        executable: /bin/bash
      register: verify_env
      changed_when: false

    - name: Display verification result
      debug:
        msg: "{{ verify_env.stdout_lines }}"
